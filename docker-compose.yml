services:
  # Appium server (no emulator). For real devices, you must also pass USB through
  # and usually run the container privileged.
  appium:
    image: appium/appium:v2.19.0-p4
    profiles: ["appium"]
    # Do NOT publish the port to the host by default (prevents CI failures when 4723 is already in use).
    # The tests container can still reach Appium via http://appium:4723 on the compose network.
    # For local debugging where you want to access Appium from the host, enable the "host-expose" profile.
    environment:
      APPIUM_BASE_PATH: "/"
      LOG_LEVEL: "debug"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-lc", "wget -qO- http://127.0.0.1:4723/status >/dev/null 2>&1"]
      interval: 5s
      timeout: 3s
      retries: 20

  # Optional profile to expose Appium to the host (useful for local debugging)
  appium-host:
    image: appium/appium:v2.19.0-p4
    profiles: ["host-expose"]
    ports:
      - "4723:4723"
    environment:
      APPIUM_BASE_PATH: "/"
    restart: unless-stopped

  tests:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      # Allow overriding from the host or Jenkins with APPIUM_SERVER_URL.
      # Default points to the compose service 'appium'.
      APPIUM_SERVER_URL: ${APPIUM_SERVER_URL:-http://appium:4723}
    volumes:
      # Persist results to host for Jenkins archival
      - ./target:/workspace/target
    command: ["mvn", "-q", "test"]
